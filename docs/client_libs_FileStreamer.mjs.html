<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: client/libs/FileStreamer.mjs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: client/libs/FileStreamer.mjs</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {BrowserLogger as Logger} from "../../shared/libs/Logger.mjs"
import {calcSha256} from "../helpers/hashing_helper.js"

class FileStreamer {

	constructor (oSocket, oFile, sCookie) {
		this.file = oFile
		this.socket = oSocket
		this.offset = 0
		this.offset_confirmed = 0 // for progress monitoring
		this.sequence = 0
		this.cookie = sCookie
	}

	start() {
		const reader = new FileReader()

		reader.onload = async()=>{
			const uint8Array = new Uint8Array(reader.result)
			const sha256sum = await calcSha256(uint8Array)

			const fileSize = uint8Array.length
			const fileType = this.file.type

			const fileName = this.file.name

			const cookie = this.cookie

			this.socket.emit("transfer_request", 
				{
					sha256sum,
					fileName, 
					fileSize,
					fileType,
					cookie
				}, 
				(response)=>{

					if (response.ok) {
						Logger.info("Transfer allowed")
						Logger.info(response.batchSize)

						while (this.offset &lt; fileSize) {
							const batch = uint8Array.slice(this.offset, this.offset + response.batchSize)
							this.socket.timeout(5000).emit("batch_data", {sequence: this.sequence++, batch}, (timeout, success)=>{
								if (timeout) {
									// todo: handle batch upload timeout
								}
								this.offset_confirmed += response.batchSize
							})
							this.offset += response.batchSize
						}

						this.socket.emit("transfer_complete", (response)=>{
							this.onTransferComplete(response)
						})

					} else {
						Logger.error("Transfer not allowed")
						Logger.error(response.error)
					}

				}
			)

		}

		reader.readAsArrayBuffer(this.file)
	}

	getProgress() {
		const progress = (this.offset_confirmed / this.file.size)
		Logger.info(progress)
		return progress
	}

	/**
	 * Event handler on completed transfer. Implement this outside
	 * of the class to handle the result
	 *
	 * @param   {Object} oResult the result of the transfer
	 *
	 * @returns {undefined}
	 */
	onTransferComplete(oResult){}

}

export default FileStreamer</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CommandController.html">CommandController</a></li><li><a href="Cryptor.html">Cryptor</a></li><li><a href="CustomerController.html">CustomerController</a></li><li><a href="CustomerMessenger.html">CustomerMessenger</a></li><li><a href="FileReceiver.html">FileReceiver</a></li><li><a href="Message.html">Message</a></li><li><a href="SocketListener.html">SocketListener</a></li><li><a href="Socketserver.html">Socketserver</a></li><li><a href="TelegramAPI.html">TelegramAPI</a></li><li><a href="TelegramListener.html">TelegramListener</a></li><li><a href="TelegramMessenger.html">TelegramMessenger</a></li><li><a href="WebhookMessage.html">WebhookMessage</a></li><li><a href="Webserver.html">Webserver</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Tue May 30 2023 19:54:52 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
